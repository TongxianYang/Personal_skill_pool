# Nginx



**应用场景：**静态web服务、反向代理、正向代理、负载均衡；

**代理功能的基石：**accept锁

**文件操作的基石：**线程池、自旋锁、信号量、互斥锁、条件变量



###### 如何保存4个web处理的最小连接数？

共享内存



###### 是否4个work进程都是监听在8888端口？

是



###### work进程如何拿锁？

**互斥锁、自旋锁**

区别：自旋锁没有发生线程切换，空转CPU忙等，加锁部分的逻辑执行时间大于线程切换时间

选择互斥锁，小于线程切换时间就选择自旋锁。 连接数多，自旋锁没问题，但连接数少，造成CPU空转，处理策略是空转一定时间后，让出CPU。

**读写锁**

**信号量**

**cas锁**

**条件变量**



###### 网络处理模型

**单线程同步非阻塞**

单线程 epoll_wait

**多线程异步**

1、主线程 epoll_wait + 线程池

2、每个线程 + epoll_wait

3、主线程 listen + 子线程recv / send  epoll



###### nginx 模块类型

1、Handler  (客户端 ---> Nginx， Nginx ---> 客户端)

2、Filtor   (服务器 ---> Nginx ---> 客户端)

3、Upstream  (客户端 ---> Nginx ---> 服务器)



实现一个防攻击的Nginx模块？

1、限制IP

2、限制频率



**静态资源服务**

. 本地文件系统提供服务

**反向代理服务**

. Nginx强大的性能

. 缓存

. 负载均衡

**API服务**

. OpenResty



###### 定时器实现所有方案

**最小堆：**最小堆和跳表在寻找最小节点的时间复杂度是一样的，但跳表占用空间要大，删除节点的效率要比跳表低。

**红黑树：**寻找最小节点的速度要比最小堆和跳表慢，但删除节点的效率是最稳定的。最小堆是完全二叉搜索树，红黑树是平衡二叉搜索树。

**跳表：**多层级的有序链表。

**时间轮：**多维数据，多线程环境下，前面3种都是单线程环境下。



###### 自旋锁和互斥锁的区别

1、互斥锁会引起线程的睡眠和切换，自旋锁基于原子操作实现，通过空转cpu的方式实现不会进行切换；

2、明确知道粒度小，使用自旋锁，明确知道粒度大，使用互斥锁；

3、处理高并发的场景，使用自旋锁， 为了均衡cpu情况下一般使用自旋锁+互斥锁，即：先自旋锁  衰减因子 互斥锁。



###### Nginx源码学习要看哪些内容？

1、实现http模块，体会nginx 一切皆模块，http请求11个阶段，7 handler；

2、实现http过滤器，文件，content->log   多个过滤器；

3、进程间通信机制，信号、共享内存、进程锁（原子操作+信号量、文件锁）；

4、upstream模块，核心问题，处理上下游网速有差异问题；

5、slab共享内存的封装；

6、如果有lua基础，一定要学习openresty  nginx + lua   lua-nginx-module + cosocket；

7、nginx 异步事件机制 + lua,  nginx 就可以连接 redis  mysql  mongodb  openresty动态web服务器。

